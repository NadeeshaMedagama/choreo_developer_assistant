# URL Validation Architecture

## System Flow Diagram

```
┌─────────────────────────────────────────────────────────────────────┐
│                          User Request                               │
│                    "How do I deploy to Choreo?"                     │
└────────────────────────────┬────────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    FastAPI Endpoint: /api/ask                       │
│                         (async function)                            │
└────────────────────────────┬────────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────────┐
│                  1. Retrieve Context from Vector DB                 │
│                       (Pinecone search)                             │
└────────────────────────────┬────────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────────┐
│                  2. Generate AI Response                            │
│                    (Azure OpenAI LLM)                               │
│                                                                     │
│  Answer: "To deploy, visit https://console.choreo.dev              │
│  and follow https://wso2.com/choreo/docs/deploy guide.             │
│  Old docs at https://old-broken-url.com are deprecated."           │
└────────────────────────────┬────────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────────┐
│              3. URL Validation Process (NEW!)                       │
│                                                                     │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │  URLValidator.validate_answer_urls()                         │  │
│  │                                                              │  │
│  │  Step 1: Extract URLs                                       │  │
│  │    - https://console.choreo.dev                             │  │
│  │    - https://wso2.com/choreo/docs/deploy                    │  │
│  │    - https://old-broken-url.com                             │  │
│  │                                                              │  │
│  │  Step 2: Validate Concurrently (async)                      │  │
│  │    ┌─────────────────┐  ┌─────────────────┐                │  │
│  │    │ URL 1           │  │ URL 2           │  ...            │  │
│  │    │ Check Cache     │  │ Check Cache     │                 │  │
│  │    │   ↓             │  │   ↓             │                 │  │
│  │    │ HEAD Request    │  │ HEAD Request    │                 │  │
│  │    │   ↓             │  │   ↓             │                 │  │
│  │    │ Status < 400?   │  │ Status < 400?   │                 │  │
│  │    │   ↓             │  │   ↓             │                 │  │
│  │    │ ✓ Valid         │  │ ✓ Valid         │  ✗ Invalid     │  │
│  │    └─────────────────┘  └─────────────────┘                │  │
│  │                                                              │  │
│  │  Step 3: Filter Invalid URLs                                │  │
│  │    Replace: https://old-broken-url.com                      │  │
│  │    With: [URL removed - not accessible]                     │  │
│  └──────────────────────────────────────────────────────────────┘  │
└────────────────────────────┬────────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────────┐
│              4. Validate Source URLs                                │
│                                                                     │
│  Sources:                                                           │
│    1. {url: "https://wso2.com/choreo", score: 0.85} → ✓ Keep      │
│    2. {url: "https://broken-link.com", score: 0.80} → ✗ Remove    │
│    3. {no url, score: 0.75} → ✓ Keep                              │
└────────────────────────────┬────────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    5. Return Filtered Response                      │
│                                                                     │
│  {                                                                  │
│    "answer": "To deploy, visit https://console.choreo.dev          │
│               and follow https://wso2.com/choreo/docs/deploy.      │
│               Old docs [URL removed - not accessible]",            │
│    "sources": [                                                     │
│      {url: "https://wso2.com/choreo", score: 0.85},               │
│      {no url, score: 0.75}                                         │
│    ],                                                               │
│    "url_validation": {                                              │
│      "total_urls": 3,                                               │
│      "valid_urls": 2,                                               │
│      "invalid_urls": 1,                                             │
│      "validation_enabled": true                                     │
│    }                                                                │
│  }                                                                  │
└────────────────────────────┬────────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    User Receives Clean Response                     │
│                   (Only working URLs included)                      │
└─────────────────────────────────────────────────────────────────────┘
```

## Component Architecture

```
┌──────────────────────────────────────────────────────────────────────┐
│                          Application Layer                           │
│                                                                      │
│  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐        │
│  │  /api/ask      │  │ /api/ask/stream│  │ /api/ask_graph │        │
│  │  (Standard)    │  │  (Streaming)   │  │   (LangGraph)  │        │
│  └───────┬────────┘  └───────┬────────┘  └────────────────┘        │
│          │                   │                                       │
│          └─────────┬─────────┘                                       │
└────────────────────┼─────────────────────────────────────────────────┘
                     │
                     ▼
┌──────────────────────────────────────────────────────────────────────┐
│                         Service Layer                                │
│                                                                      │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │                    URLValidator Service                        │ │
│  │                        (Singleton)                             │ │
│  │                                                                │ │
│  │  Properties:                                                   │ │
│  │    - timeout: int (default: 5s)                               │ │
│  │    - max_concurrent: int (default: 10)                        │ │
│  │    - enable_validation: bool (default: true)                  │ │
│  │    - _cache: Dict[str, bool] (in-memory)                      │ │
│  │    - _semaphore: asyncio.Semaphore                            │ │
│  │                                                                │ │
│  │  Methods:                                                      │ │
│  │    • extract_urls_from_text(text) → List[str]                 │ │
│  │    • validate_url(url, session) → bool                        │ │
│  │    • validate_urls(urls) → Dict[str, bool]                    │ │
│  │    • validate_answer_urls(answer) → (str, Dict)               │ │
│  │    • validate_and_filter_sources(sources) → List[Dict]        │ │
│  │    • clear_cache()                                            │ │
│  └────────────────────────────────────────────────────────────────┘ │
│                                                                      │
│  Other Services:                                                     │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │
│  │  LLMService  │  │ ContextMgr   │  │ VectorClient │              │
│  └──────────────┘  └──────────────┘  └──────────────┘              │
└──────────────────────────────────────────────────────────────────────┘
                     │
                     ▼
┌──────────────────────────────────────────────────────────────────────┐
│                        External Layer                                │
│                                                                      │
│  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐        │
│  │ aiohttp        │  │ External URLs  │  │ Pinecone DB    │        │
│  │ (HTTP Client)  │  │ (Validation)   │  │ (Vector Store) │        │
│  └────────────────┘  └────────────────┘  └────────────────┘        │
└──────────────────────────────────────────────────────────────────────┘
```

## Data Flow

```
┌─────────────────────┐
│   User Question     │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐      ┌──────────────────┐
│  Vector Search      │──────│ Retrieve Context │
└──────────┬──────────┘      └──────────────────┘
           │
           ▼
┌─────────────────────┐      ┌──────────────────┐
│  LLM Generation     │──────│ Generate Answer  │
└──────────┬──────────┘      │ with URLs        │
           │                 └──────────────────┘
           ▼
┌─────────────────────┐
│  Extract URLs       │──────────┐
└──────────┬──────────┘          │
           │                     │
           ▼                     ▼
┌─────────────────────┐    ┌──────────────────┐
│  Check Cache        │    │ Cache Hit?       │
└──────────┬──────────┘    │ Return cached    │
           │               └──────────────────┘
           ▼
┌─────────────────────┐
│  Concurrent         │──────────┐
│  Validation         │          │
└──────────┬──────────┘          │
           │                     │
           ├─────────────────────┤
           │                     │
           ▼                     ▼
    ┌──────────┐          ┌──────────┐
    │ HEAD Req │          │ HEAD Req │  ... (up to 10 concurrent)
    └────┬─────┘          └────┬─────┘
         │                     │
         ▼                     ▼
    ┌──────────┐          ┌──────────┐
    │ Valid?   │          │ Invalid? │
    └────┬─────┘          └────┬─────┘
         │                     │
         └──────────┬──────────┘
                    │
                    ▼
           ┌─────────────────┐
           │  Cache Results  │
           └────────┬────────┘
                    │
                    ▼
           ┌─────────────────┐
           │ Filter Answer   │
           └────────┬────────┘
                    │
                    ▼
           ┌─────────────────┐
           │ Filter Sources  │
           └────────┬────────┘
                    │
                    ▼
           ┌─────────────────┐
           │ Return Response │
           └─────────────────┘
```

## Validation Decision Tree

```
                    ┌─────────────┐
                    │   URL       │
                    └──────┬──────┘
                           │
                           ▼
                    ┌─────────────┐
                    │ In Cache?   │
                    └──────┬──────┘
                           │
                ┌──────────┴──────────┐
                │                     │
                ▼                     ▼
         ┌──────────┐          ┌──────────┐
         │   YES    │          │    NO    │
         └────┬─────┘          └────┬─────┘
              │                     │
              ▼                     ▼
      ┌──────────────┐      ┌──────────────┐
      │Return Cached │      │  HEAD Req    │
      │   Result     │      │  (timeout 5s)│
      └──────────────┘      └──────┬───────┘
                                   │
                        ┌──────────┴──────────┐
                        │                     │
                        ▼                     ▼
                 ┌──────────┐          ┌──────────┐
                 │Success   │          │  Error   │
                 │Status<400│          │  or      │
                 └────┬─────┘          │Timeout   │
                      │                └────┬─────┘
                      │                     │
                      ▼                     ▼
               ┌──────────┐          ┌──────────┐
               │  VALID   │          │ GET Req  │
               │ (Cache)  │          │ Fallback │
               └──────────┘          └────┬─────┘
                                          │
                               ┌──────────┴──────────┐
                               │                     │
                               ▼                     ▼
                        ┌──────────┐          ┌──────────┐
                        │Success   │          │  Error   │
                        │Status<400│          │  or      │
                        └────┬─────┘          │Timeout   │
                             │                └────┬─────┘
                             │                     │
                             ▼                     ▼
                      ┌──────────┐          ┌──────────┐
                      │  VALID   │          │ INVALID  │
                      │ (Cache)  │          │ (Cache)  │
                      └──────────┘          └──────────┘
```

## Configuration Impact

```
┌────────────────────────────────────────────────────────┐
│              ENABLE_URL_VALIDATION=true                │
└────────────────────────────────────────────────────────┘
                          │
              ┌───────────┴───────────┐
              │                       │
              ▼                       ▼
    ┌─────────────────┐    ┌─────────────────┐
    │ Validate URLs   │    │ Filter Invalid  │
    │ (Concurrent)    │    │ URLs & Sources  │
    └─────────────────┘    └─────────────────┘


┌────────────────────────────────────────────────────────┐
│              ENABLE_URL_VALIDATION=false               │
└────────────────────────────────────────────────────────┘
                          │
                          ▼
                ┌─────────────────┐
                │   Skip All      │
                │  Validation     │
                │  (Passthrough)  │
                └─────────────────┘
```

## Error Handling Flow

```
         ┌─────────────┐
         │ Validate URL│
         └──────┬──────┘
                │
                ▼
         ┌─────────────┐
         │   Try HEAD  │
         └──────┬──────┘
                │
     ┌──────────┴──────────┐
     │                     │
     ▼                     ▼
┌──────────┐        ┌──────────┐
│ Success  │        │  Error   │
└──────────┘        └────┬─────┘
                         │
              ┌──────────┴──────────┐
              │                     │
              ▼                     ▼
       ┌──────────┐          ┌──────────┐
       │Timeout   │          │Network   │
       │Error     │          │Error     │
       └────┬─────┘          └────┬─────┘
            │                     │
            └──────────┬──────────┘
                       │
                       ▼
                ┌──────────┐
                │Try GET   │
                │Fallback  │
                └────┬─────┘
                     │
          ┌──────────┴──────────┐
          │                     │
          ▼                     ▼
    ┌──────────┐          ┌──────────┐
    │ Success  │          │  Error   │
    └────┬─────┘          └────┬─────┘
         │                     │
         ▼                     ▼
    ┌──────────┐          ┌──────────┐
    │  VALID   │          │ INVALID  │
    │  + Log   │          │  + Log   │
    │  + Cache │          │  + Cache │
    └──────────┘          └──────────┘
```

